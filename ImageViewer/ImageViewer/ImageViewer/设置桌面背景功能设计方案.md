# è®¾ç½®æ¡Œé¢èƒŒæ™¯åŠŸèƒ½è®¾è®¡æ–¹æ¡ˆ

## åŠŸèƒ½æ¦‚è¿°

åœ¨å›¾ç‰‡æµè§ˆå™¨çš„å·¥å…·æ ä¸­æ·»åŠ ä¸€ä¸ª"è®¾ç½®ä¸ºæ¡Œé¢èƒŒæ™¯"æŒ‰é’®ï¼Œç”¨æˆ·ç‚¹å‡»åå¯ä»¥å°†å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡è®¾ç½®ä¸º Windows ç³»ç»Ÿçš„æ¡Œé¢èƒŒæ™¯å›¾ç‰‡ã€‚

## æ¶æ„è®¾è®¡

### 1. ç”¨æˆ·ç•Œé¢å±‚ (QML)

#### 1.1 æ–°å¢æŒ‰é’®ç»„ä»¶
- **æ–‡ä»¶å**: `SetWallpaperToolButton.qml`
- **åŠŸèƒ½**: è®¾ç½®æ¡Œé¢èƒŒæ™¯çš„å·¥å…·æ æŒ‰é’®
- **ä½ç½®**: ä¸ç°æœ‰çš„ `RotateToolButton` å’Œ `SlideToolButton` å¹¶åˆ—æ”¾ç½®

#### 1.2 å·¥å…·æ å¸ƒå±€ä¿®æ”¹
- **æ–‡ä»¶**: `MyToolBar.qml`
- **ä¿®æ”¹**: åœ¨ç°æœ‰æŒ‰é’®ç»„åˆä¸­æ·»åŠ æ–°çš„æ¡Œé¢èƒŒæ™¯è®¾ç½®æŒ‰é’®
- **å¸ƒå±€é¡ºåº**: å»ºè®®æ”¾åœ¨æ—‹è½¬æŒ‰é’®å’Œå¹»ç¯ç‰‡æŒ‰é’®ä¹‹é—´

### 2. ä¸šåŠ¡é€»è¾‘å±‚ (C++)

#### 2.1 CSlide ç±»æ‰©å±•
- **æ–‡ä»¶**: `cslide.h` å’Œ `cslide.cpp`
- **æ–°å¢æ–¹æ³•**: `Q_INVOKABLE bool setAsWallpaper(QString imagePath)`
- **åŠŸèƒ½**: è°ƒç”¨ Windows API è®¾ç½®æ¡Œé¢èƒŒæ™¯

#### 2.2 Windows API é›†æˆ
ä½¿ç”¨ Windows API `SystemParametersInfo` å‡½æ•°è®¾ç½®æ¡Œé¢èƒŒæ™¯ï¼š
```cpp
#include <windows.h>
bool setDesktopWallpaper(const QString& imagePath);
```

## è¯¦ç»†å®ç°æ–¹æ¡ˆ

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæ¡Œé¢èƒŒæ™¯è®¾ç½®æŒ‰é’®ç»„ä»¶

#### SetWallpaperToolButton.qml
```qml
import QtQuick
import QtQuick.Controls

/**
 * è®¾ç½®æ¡Œé¢èƒŒæ™¯æŒ‰é’®ç»„ä»¶
 * åŠŸèƒ½ï¼šç‚¹å‡»åå°†å½“å‰å›¾ç‰‡è®¾ç½®ä¸ºæ¡Œé¢èƒŒæ™¯
 */
Button {
    id: root

    width: 25
    height: 25

    // æŒ‰é’®å›¾æ ‡ - ä½¿ç”¨æ¡Œé¢/æ˜¾ç¤ºå™¨å›¾æ ‡
    background: Rectangle {
        color: root.hovered ? "#5A5A5A" : "transparent"
        radius: 3

        Text {
            anchors.centerIn: parent
            text: "ğŸ–¥ï¸"  // å¯ä»¥æ›¿æ¢ä¸ºè‡ªå®šä¹‰å›¾æ ‡
            font.pixelSize: 16
            color: root.enabled ? "#FFFFFF" : "#888888"
        }
    }

    // å·¥å…·æç¤º
    ToolTip {
        visible: root.hovered
        text: "è®¾ç½®ä¸ºæ¡Œé¢èƒŒæ™¯"
        delay: 1000
    }

    // ç‚¹å‡»æ•ˆæœ
    onClicked: {
        console.log("è®¾ç½®æ¡Œé¢èƒŒæ™¯æŒ‰é’®è¢«ç‚¹å‡»")
        root.setWallpaper()
    }

    // è®¾ç½®æ¡Œé¢èƒŒæ™¯çš„å‡½æ•° - éœ€è¦åœ¨å¤–éƒ¨è¿æ¥åˆ°å…·ä½“å®ç°
    signal wallpaperRequested()

    function setWallpaper() {
        wallpaperRequested()
    }
}
```

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹å·¥å…·æ å¸ƒå±€

#### MyToolBar.qml ä¿®æ”¹
åœ¨ `RowLayout` ä¸­æ·»åŠ æ–°æŒ‰é’®ï¼š

```qml
// åœ¨ RowLayout ä¸­æ·»åŠ ï¼ˆç¬¬45è¡Œé™„è¿‘ï¼‰
RowLayout {
    anchors.right: parent.right
    anchors.rightMargin: 20
    layoutDirection: Qt.RightToLeft
    anchors.verticalCenter: parent.verticalCenter
    spacing: 15

    // æ—‹è½¬æŒ‰é’®
    RotateToolButton {
        id: rotateButton
        onClicked: {
            currentRotationAngle = (currentRotationAngle + 90) % 360
            rotateDegreeChanged(currentRotationAngle)
            rotateClicked()
        }
    }

    // æ–°å¢ï¼šè®¾ç½®æ¡Œé¢èƒŒæ™¯æŒ‰é’®
    SetWallpaperToolButton {
        id: wallpaperButton
        onWallpaperRequested: {
            if (toolBar.slideEngine && toolBar.imageSource !== "") {
                var imagePath = toolBar.imageSource.toString().replace("file:///", "")
                var success = toolBar.slideEngine.setAsWallpaper(imagePath)
                if (success) {
                    console.log("æ¡Œé¢èƒŒæ™¯è®¾ç½®æˆåŠŸ:", imagePath)
                } else {
                    console.log("æ¡Œé¢èƒŒæ™¯è®¾ç½®å¤±è´¥:", imagePath)
                }
            }
        }
    }

    // å¹»ç¯ç‰‡æ’­æ”¾æŒ‰é’®
    SlideToolButton {
        id: slideButton
        marginValue: toolBar.marginValue + 2
        imageSource: toolBar.imageSource
        slideEngine: toolBar.slideEngine
    }
}
```

### ç¬¬ä¸‰æ­¥ï¼šæ‰©å±• CSlide ç±»

#### cslide.h ä¿®æ”¹
```cpp
// åœ¨ public Q_INVOKABLE æ–¹æ³•åŒºåŸŸæ·»åŠ ï¼š
Q_INVOKABLE bool setAsWallpaper(QString imagePath);

private:
// æ·»åŠ ç§æœ‰è¾…åŠ©æ–¹æ³•
bool setDesktopWallpaper(const QString& imagePath);
```

#### cslide.cpp å®ç°
```cpp
#include <QStandardPaths>
#include <QDir>
#include <QFileInfo>

#ifdef Q_OS_WIN
#include <windows.h>
#include <shlobj.h>
#endif

bool CSlide::setAsWallpaper(QString imagePath)
{
    if (imagePath.isEmpty()) {
        qWarning() << "å›¾ç‰‡è·¯å¾„ä¸ºç©ºï¼Œæ— æ³•è®¾ç½®æ¡Œé¢èƒŒæ™¯";
        return false;
    }

    // ç¡®ä¿è·¯å¾„æ ¼å¼æ­£ç¡®
    QFileInfo fileInfo(imagePath);
    if (!fileInfo.exists()) {
        qWarning() << "å›¾ç‰‡æ–‡ä»¶ä¸å­˜åœ¨:" << imagePath;
        return false;
    }

    // æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ”¯æŒä½œä¸ºæ¡Œé¢èƒŒæ™¯
    QString suffix = fileInfo.suffix().toLower();
    if (suffix != "jpg" && suffix != "jpeg" && suffix != "png" && suffix != "bmp") {
        qWarning() << "ä¸æ”¯æŒçš„å›¾ç‰‡æ ¼å¼ä½œä¸ºæ¡Œé¢èƒŒæ™¯:" << suffix;
        return false;
    }

    return setDesktopWallpaper(fileInfo.absoluteFilePath());
}

bool CSlide::setDesktopWallpaper(const QString& imagePath)
{
#ifdef Q_OS_WIN
    // Windows å¹³å°å®ç°
    std::wstring wImagePath = imagePath.toStdWString();

    // è®¾ç½®æ¡Œé¢èƒŒæ™¯
    BOOL result = SystemParametersInfoW(
        SPI_SETDESKWALLPAPER,    // è®¾ç½®æ¡Œé¢èƒŒæ™¯
        0,                       // æœªä½¿ç”¨
        (LPVOID)wImagePath.c_str(), // å›¾ç‰‡æ–‡ä»¶è·¯å¾„
        SPIF_UPDATEINIFILE | SPIF_SENDCHANGE  // æ›´æ–°é…ç½®å¹¶é€šçŸ¥ç³»ç»Ÿ
    );

    if (result) {
        qDebug() << "æ¡Œé¢èƒŒæ™¯è®¾ç½®æˆåŠŸ:" << imagePath;
        return true;
    } else {
        DWORD error = GetLastError();
        qWarning() << "æ¡Œé¢èƒŒæ™¯è®¾ç½®å¤±è´¥ï¼Œé”™è¯¯ä»£ç :" << error;
        return false;
    }
#else
    // å…¶ä»–å¹³å°æš‚ä¸æ”¯æŒ
    qWarning() << "å½“å‰å¹³å°ä¸æ”¯æŒè®¾ç½®æ¡Œé¢èƒŒæ™¯åŠŸèƒ½";
    return false;
#endif
}
```

### ç¬¬å››æ­¥ï¼šCMakeLists.txt é…ç½®

ç¡®ä¿é¡¹ç›®é“¾æ¥äº†å¿…è¦çš„ Windows åº“ï¼š

```cmake
# åœ¨ CMakeLists.txt ä¸­æ·»åŠ ï¼ˆå¦‚æœéœ€è¦ï¼‰
if(WIN32)
    target_link_libraries(appImageViewer PRIVATE
        user32
        shell32
    )
endif()
```

## ç”¨æˆ·ä½“éªŒè®¾è®¡

### 1. è§†è§‰åé¦ˆ
- **æŒ‰é’®å›¾æ ‡**: ä½¿ç”¨æ¡Œé¢/æ˜¾ç¤ºå™¨å›¾æ ‡ (ğŸ–¥ï¸) æˆ–è‡ªå®šä¹‰å›¾æ ‡
- **æ‚¬åœæ•ˆæœ**: é¼ æ ‡æ‚¬åœæ—¶èƒŒæ™¯è‰²å˜åŒ–
- **å·¥å…·æç¤º**: æ˜¾ç¤º"è®¾ç½®ä¸ºæ¡Œé¢èƒŒæ™¯"æç¤ºæ–‡å­—

### 2. æ“ä½œåé¦ˆ
- **æˆåŠŸæç¤º**: æ§åˆ¶å°è¾“å‡ºæˆåŠŸä¿¡æ¯ï¼ˆå¯æ‰©å±•ä¸º Toast æç¤ºï¼‰
- **å¤±è´¥å¤„ç†**: æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼ˆå¯æ‰©å±•ä¸ºé”™è¯¯å¯¹è¯æ¡†ï¼‰
- **çŠ¶æ€æ£€æŸ¥**: ä»…åœ¨æœ‰æœ‰æ•ˆå›¾ç‰‡æ—¶å¯ç”¨æŒ‰é’®

### 3. äº¤äº’é€»è¾‘
- **å•å‡»æ“ä½œ**: ç‚¹å‡»æŒ‰é’®ç«‹å³è®¾ç½®å½“å‰å›¾ç‰‡ä¸ºæ¡Œé¢èƒŒæ™¯
- **å®‰å…¨æ£€æŸ¥**: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€æ ¼å¼æ˜¯å¦æ”¯æŒ
- **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†è®¾ç½®å¤±è´¥çš„æƒ…å†µ

## æ‰©å±•åŠŸèƒ½å»ºè®®

### 1. èƒŒæ™¯è®¾ç½®é€‰é¡¹
- **å¹³é“ºæ–¹å¼**: æ‹‰ä¼¸ã€å¹³é“ºã€å±…ä¸­ã€é€‚åº”ç­‰
- **è®¾ç½®æ¨¡å¼**: æ¡Œé¢èƒŒæ™¯ã€é”å±èƒŒæ™¯æˆ–ä¸¤è€…

### 2. ç”¨æˆ·åé¦ˆå¢å¼º
- **Toast é€šçŸ¥**: ä½¿ç”¨ QML ç»„ä»¶æ˜¾ç¤ºè®¾ç½®ç»“æœ
- **è¿›åº¦æŒ‡ç¤º**: å¯¹äºå¤§å›¾ç‰‡æ–‡ä»¶æ˜¾ç¤ºè®¾ç½®è¿›åº¦

### 3. è·¨å¹³å°æ”¯æŒ
- **macOS æ”¯æŒ**: ä½¿ç”¨ AppleScript æˆ–ç³»ç»Ÿ API
- **Linux æ”¯æŒ**: æ”¯æŒå„ç§æ¡Œé¢ç¯å¢ƒï¼ˆGNOMEã€KDE ç­‰ï¼‰

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `SetWallpaperToolButton.qml` - æ¡Œé¢èƒŒæ™¯è®¾ç½®æŒ‰é’®ç»„ä»¶
2. å¯é€‰ï¼šè‡ªå®šä¹‰å›¾æ ‡æ–‡ä»¶ï¼ˆå¦‚ `wallpaper-icon.png`ï¼‰

### ä¿®æ”¹æ–‡ä»¶
1. `MyToolBar.qml` - æ·»åŠ æ–°æŒ‰é’®åˆ°å·¥å…·æ 
2. `cslide.h` - æ·»åŠ è®¾ç½®æ¡Œé¢èƒŒæ™¯æ–¹æ³•å£°æ˜
3. `cslide.cpp` - å®ç°æ¡Œé¢èƒŒæ™¯è®¾ç½®åŠŸèƒ½
4. `CMakeLists.txt` - å¯èƒ½éœ€è¦æ·»åŠ  Windows åº“é“¾æ¥

## æµ‹è¯•è®¡åˆ’

### 1. åŠŸèƒ½æµ‹è¯•
- æµ‹è¯•ä¸åŒæ ¼å¼å›¾ç‰‡çš„èƒŒæ™¯è®¾ç½®
- æµ‹è¯•ä¸åŒå°ºå¯¸å›¾ç‰‡çš„å¤„ç†
- æµ‹è¯•æ–‡ä»¶ä¸å­˜åœ¨æ—¶çš„é”™è¯¯å¤„ç†

### 2. å…¼å®¹æ€§æµ‹è¯•
- Windows 10/11 ä¸åŒç‰ˆæœ¬æµ‹è¯•
- ä¸åŒåˆ†è¾¨ç‡æ˜¾ç¤ºå™¨æµ‹è¯•
- å¤šæ˜¾ç¤ºå™¨ç¯å¢ƒæµ‹è¯•

### 3. æ€§èƒ½æµ‹è¯•
- å¤§æ–‡ä»¶å›¾ç‰‡çš„è®¾ç½®é€Ÿåº¦
- å†…å­˜ä½¿ç”¨æƒ…å†µç›‘æ§

## å®æ–½ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§
1. æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼ˆWindows å¹³å°ï¼‰
2. åŸºæœ¬é”™è¯¯å¤„ç†
3. ç”¨æˆ·ç•Œé¢é›†æˆ

### ä¸­ä¼˜å…ˆçº§
1. ç”¨æˆ·åé¦ˆä¼˜åŒ–
2. æ›´ä¸°å¯Œçš„å›¾æ ‡å’Œè§†è§‰æ•ˆæœ
3. è®¾ç½®é€‰é¡¹æ‰©å±•

### ä½ä¼˜å…ˆçº§
1. è·¨å¹³å°æ”¯æŒ
2. é«˜çº§è®¾ç½®é€‰é¡¹
3. èƒŒæ™¯è®¾ç½®å†å²è®°å½•

## ç»“è¯­

æ­¤æ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªå®Œæ•´çš„æ¡Œé¢èƒŒæ™¯è®¾ç½®åŠŸèƒ½å®ç°è·¯å¾„ï¼Œä¿æŒäº†ä¸ç°æœ‰ä»£ç æ¶æ„çš„ä¸€è‡´æ€§ï¼ŒåŒæ—¶ç¡®ä¿äº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒã€‚å®ç°è¿‡ç¨‹ä¸­å»ºè®®åˆ†æ­¥è¿›è¡Œï¼Œå…ˆå®Œæˆæ ¸å¿ƒåŠŸèƒ½ï¼Œå†é€æ­¥æ·»åŠ å¢å¼ºç‰¹æ€§ã€‚